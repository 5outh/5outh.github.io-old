<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Benjamin Kovach</title>

    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link rel="stylesheet" type="text/css" href="../css/default.css" />
    <link rel="stylesheet" type="text/css" href="../css/syntax.css" />
    <link rel="stylesheet" type="text/css" href="../css/site.css" />
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.4.3/jquery.min.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css" />
    <link rel="stylesheet" href="../js/lightbox2/dist/css/lightbox.min.css" />
    <script type="text/javascript" src="../js/lightbox2/dist/js/lightbox-plus-jquery.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
  </head>
  <body style="margin-left: auto; margin-right: auto; display: block; max-width:800px">
    <div id="left"></div>
    <div class="wrapper">
      <header>
        <ul id="nav">
    <li><a href="../">Home</a></li>
    <li><a href="../contact.html">About</a></li>
    <li><a href="../atom.xml">Atom</a></li>
    <li><a href="../rss.xml">RSS</a></li>
</ul>


        <h3 id="blog_title">Benjamin Kovach</h3>
      </header>
      <section>
        
          <h4 class="post-title">Posting to Twitter via HTTP in haskell</h4>
        
        <p>
<div class="post_body">
  <p>When working on <a href="https://twitter.com/_rapcandy">rapcandy</a>, I had a bit of trouble getting the twitter connector bit working. I’ll detail here what worked – if you need to connect to Twitter via one of your Haskell applications, this should help you out.</p>
<h3 id="setting-up-a-twitter-application">Setting up a Twitter Application</h3>
<p>In order to interact with Twitter programmatically, you’ll first need to set up an application via <a href="http://dev.twitter.com">dev.twitter.com</a>. You can create a new app here and generate new API keys for it. Once you do this, you’ll be able to <em>read</em> from twitter. If you want to write to twitter (like I did, with <a href="https://twitter.com/_rapcandy">@_rapcandy</a>), you can go to the <em>API Keys</em> tab, click “modify app permissions” and give it write access. You can then generate new API keys which will permit writing.</p>
<p>Copy down your API key, API secret, Access token, and Access token secret into a JSON file called <code>config.json</code> that looks like this:</p>
<div class="sourceCode"><pre class="sourceCode json"><code class="sourceCode json"><span class="fu">{</span>
    <span class="dt">&quot;apiKey&quot;</span><span class="fu">:</span> <span class="st">&quot;&lt;api key&gt;&quot;</span><span class="fu">,</span>
    <span class="dt">&quot;apiSecret&quot;</span><span class="fu">:</span> <span class="st">&quot;&lt;api secret&gt;&quot;</span><span class="fu">,</span>
    <span class="dt">&quot;userKey&quot;</span><span class="fu">:</span> <span class="st">&quot;&lt;user key&gt;&quot;</span><span class="fu">,</span>
    <span class="dt">&quot;userSecret&quot;</span><span class="fu">:</span> <span class="st">&quot;&lt;user secret&gt;&quot;</span>
<span class="fu">}</span></code></pre></div>
<p>Now everything’s in place to be able to start interacting with Twitter via Haskell.</p>
<h3 id="posting-to-twitter">Posting to Twitter</h3>
<p>We’ll be using <code>aeson</code>, <code>HTTP</code>, and <code>authenticate-oauth</code> (Twitter uses OAuth to authenticate its users) to handle the transaction. A bit of boilerplate:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">{-# LANGUAGE DeriveGeneric             #-}</span>
<span class="ot">{-# LANGUAGE NoMonomorphismRestriction #-}</span>
<span class="ot">{-# LANGUAGE OverloadedStrings         #-}</span>
<span class="ot">{-# LANGUAGE RecordWildCards           #-}</span>

<span class="kw">import           </span><span class="dt">Control.Monad</span>
<span class="kw">import           </span><span class="dt">Data.Aeson</span>
<span class="kw">import           </span><span class="dt">GHC.Generics</span>
<span class="kw">import           </span><span class="dt">Data.ByteString</span>
<span class="kw">import qualified</span> <span class="dt">Data.ByteString.Char8</span>   <span class="kw">as</span> <span class="dt">B</span>
<span class="kw">import qualified</span> <span class="dt">Data.ByteString.Lazy</span>    <span class="kw">as</span> <span class="dt">BL</span>
<span class="kw">import qualified</span> <span class="dt">Network.HTTP.Base</span>       <span class="kw">as</span> <span class="dt">HTTP</span>
<span class="kw">import           </span><span class="dt">Network.HTTP.Client</span>
<span class="kw">import           </span><span class="dt">Network.HTTP.Client.TLS</span>
<span class="kw">import           </span><span class="dt">Network.HTTP.Types</span>
<span class="kw">import           </span><span class="dt">Web.Authenticate.OAuth</span></code></pre></div>
<p>First thing’s first, we need to be able to pull in our config file in order to access the keys for our application. We “magically” do this using <code>Aeson</code>, deriving <code>Generic</code> and making automatic instances of <code>{To, From}JSON</code> for our user-defined <code>Config</code> type.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">data</span> <span class="dt">Config</span> <span class="fu">=</span> <span class="dt">Config</span> {
<span class="ot">    apiKey       ::</span> <span class="dt">String</span>,
<span class="ot">    apiSecret    ::</span> <span class="dt">String</span>,
<span class="ot">    userKey      ::</span> <span class="dt">String</span>,
<span class="ot">    userSecret   ::</span> <span class="dt">String</span>
  } <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Generic</span>)

<span class="kw">instance</span> <span class="dt">FromJSON</span> <span class="dt">Config</span>
<span class="kw">instance</span> <span class="dt">ToJSON</span> <span class="dt">Config</span></code></pre></div>
<p>We can pull in a <code>Config</code> from a file with a basic function <code>configFromFile</code>:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">configFromFile ::</span> FilePath <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">String</span> <span class="dt">Config</span>)
configFromFile path <span class="fu">=</span> <span class="kw">do</span>
  contents <span class="ot">&lt;-</span> BL.readFile path
  return <span class="fu">$</span> eitherDecode contents</code></pre></div>
<p>Now calling <code>configFromFile &quot;config.json&quot;</code> should return something like <code>Right (Config{...})</code>. Now we can start authenticating requests to the Twitter API. The following function is adapted from the <a href="http://hackage.haskell.org/package/yesod-auth-0.7.2/docs/src/Yesod-Auth-OAuth.html">Yesod source code</a> to be less specific to Yesod:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">oauthTwitter ::</span> <span class="dt">ByteString</span> <span class="ot">-&gt;</span> <span class="dt">ByteString</span> <span class="ot">-&gt;</span> <span class="dt">OAuth</span>
oauthTwitter key secret <span class="fu">=</span>
  newOAuth { oauthServerName      <span class="fu">=</span> <span class="st">&quot;twitter&quot;</span>
           , oauthRequestUri      <span class="fu">=</span> <span class="st">&quot;https://api.twitter.com/oauth/request_token&quot;</span>
           , oauthAccessTokenUri  <span class="fu">=</span> <span class="st">&quot;https://api.twitter.com/oauth/access_token&quot;</span>
           , oauthAuthorizeUri    <span class="fu">=</span> <span class="st">&quot;https://api.twitter.com/oauth/authorize&quot;</span>
           , oauthSignatureMethod <span class="fu">=</span> <span class="dt">HMACSHA1</span>
           , oauthConsumerKey     <span class="fu">=</span> key
           , oauthConsumerSecret  <span class="fu">=</span> secret
           , oauthVersion         <span class="fu">=</span> <span class="dt">OAuth10a</span>
           }</code></pre></div>
<p>Here we pass in our OAuth consumer key and secret to build an <code>OAuth</code>; these correspond to the Twitter API key/secret, and is one half of what we need to fully authenticate Twitter requests. The other half is a <code>Credential</code>, which we can build with <code>newCredential</code> using our <em>user</em> key and secret. We can fully sign an arbitrary request using a <code>Config</code>:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">signWithConfig ::</span> <span class="dt">Config</span> <span class="ot">-&gt;</span> <span class="dt">Request</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Request</span>
signWithConfig <span class="dt">Config</span>{<span class="fu">..</span>} <span class="fu">=</span> signOAuth
  (oauthTwitter (B.pack apiKey) (B.pack apiSecret))
  (newCredential (B.pack userKey) (B.pack userSecret))</code></pre></div>
<p>Now all we have to do is actually <em>send</em> a request (post a status!), which is simple but took me a while to finagle into place. There are three things to keep in mind here:</p>
<ol style="list-style-type: decimal">
<li>We must <code>urlEncode</code> the status we want to send.</li>
<li>We must <code>POST</code>; not <code>GET</code>.</li>
<li>We must use <code>tlsManagerSettings</code> to enable TLS for our request (otherwise, the request won’t go through)</li>
</ol>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">tweet ::</span> <span class="dt">Config</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Response</span> <span class="dt">BL.ByteString</span>)
tweet config status <span class="fu">=</span> <span class="kw">do</span>
  url <span class="ot">&lt;-</span> parseUrl <span class="fu">$</span> <span class="st">&quot;https://api.twitter.com/1.1/statuses/update.json?status=&quot;</span> <span class="fu">++</span> HTTP.urlEncode status
  req <span class="ot">&lt;-</span> signWithConfig config url{ method <span class="fu">=</span> <span class="st">&quot;POST&quot;</span> }
  manager <span class="ot">&lt;-</span> newManager tlsManagerSettings
  httpLbs req manager</code></pre></div>
<p>Using this code and a sufficiently permissive Twitter application, you should be able to adapt this code to send requests to any of the <a href="https://dev.twitter.com/docs/api/1.1">Twitter REST API endpoints</a> from Haskell.</p>
<p>Ben</p>
</div>

<div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'abstract-nonsense'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

</p>
      </section>
      <footer class="footer">
        © 2018 Benjamin Kovach
        <br />
        Site proudly generated by <a href="https://jaspervdj.be/hakyll/">Hakyll</a>
      </footer>
    </div>
    <!-- Google Analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-53651640-1', 'auto');
      ga('send', 'pageview');

    </script>
    <script>
      lightbox.option({
        resizeDuration: 200,
      })
    </script>
  </body>
</html>
