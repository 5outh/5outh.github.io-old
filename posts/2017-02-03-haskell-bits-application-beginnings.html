<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Benjamin Kovach</title>

    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link rel="stylesheet" type="text/css" href="../css/default.css" />
    <link rel="stylesheet" type="text/css" href="../css/syntax.css" />
    <link rel="stylesheet" type="text/css" href="../css/site.css" />
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.4.3/jquery.min.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css" />
    <link rel="stylesheet" href="../js/lightbox2/dist/css/lightbox.min.css" />
    <script type="text/javascript" src="../js/lightbox2/dist/js/lightbox-plus-jquery.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
  </head>
  <body style="margin-left: auto; margin-right: auto; display: block; max-width:800px">
    <div id="left"></div>
    <div class="wrapper">
      <header>
        <ul id="nav">
    <li><a href="../">Home</a></li>
    <li><a href="http://shop.kovach.me/">Shop</a></li>
    <!--TODO: Art display -->
    <li><a href="../contact.html">About</a></li>
    <li><a href="../atom.xml">Atom</a>/<a href="../rss.xml">RSS</a></li>
</ul>


        <h3 id="blog_title">Benjamin Kovach</h3>
      </header>
      <section>
        
          <h4 class="post-title">Haskell Bits #2: Application Beginnings</h4>
        
        <p>
<div class="post_body">
  <p>Are you comfortable creating data types, manipulating lists, composing functions, etc, but not sure how to make a “useful program” with haskell? This is a very common stumbling block when learning. It might be the complaint I’ve heard the most.</p>
<p>In this <em>Haskell Bit</em>, I want to walk through a pattern I have commonly seen in haskell applications. The pattern isn’t specific to haskell - it’s commonplace in tons of programming environments. It’s just a little less obvious how to get here with Haskell.</p>
<p>Here’s the pattern:</p>
<ul>
<li>Read some configuration (we’ll read it from the environment)</li>
<li>Set up some program state that will be manipulated over the course of the program</li>
<li>Run the program!</li>
</ul>
<p>The <a href="https://hackage.haskell.org/package/mtl"><code>mtl</code></a> package will need to be installed to run these examples.</p>
<p>In haskell, we have to be explicit about our the shape of our state and environment. A common way to represent a program with access to these basic needs, and not much else, is with the following data type:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">import </span><span class="dt">Control.Monad.Reader</span>
<span class="kw">import </span><span class="dt">Control.Monad.State</span>

<span class="kw">type</span> <span class="dt">Program</span> state config a <span class="fu">=</span> <span class="dt">StateT</span> state (<span class="dt">ReaderT</span> config <span class="dt">IO</span>) a</code></pre></div>
<p>This data type expresses the following:</p>
<ul>
<li>We can read and manipulate the internal state of our program (of type <code>state</code>)</li>
<li>We can read (and only read) values of type <code>config</code> in our program</li>
<li>We can access IO</li>
</ul>
<p>For those who aren’t familiar, this is called a “monad transformer stack”. It’s just an expression of the effects our program can have.</p>
<p>With this, we’re going to build something extremely contrived. It should demonstrate the utility of this pattern, however. Here’s what we’ll do:</p>
<ul>
<li>Read two environment variables, <code>COUNT_BY</code>, and <code>COUNT_UP_TO</code></li>
<li>It will start at <code>0</code>, and count by <code>COUNT_BY</code> steps, up to <code>COUNT_UP_TO</code>, printing out each value.</li>
</ul>
<p>To do this, we need IO (to print), a read-only environment (to store the environment variables in), and some state (the current count). Sounds like it fits the pattern. Let’s see what it looks like!</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">import </span><span class="dt">Control.Monad.State</span>
<span class="kw">import </span><span class="dt">Control.Monad.Reader</span>
<span class="kw">import </span><span class="dt">Control.Monad.IO.Class</span>
<span class="kw">import </span><span class="dt">Data.Monoid</span>
<span class="kw">import </span><span class="dt">System.Environment</span>

<span class="kw">type</span> <span class="dt">Program</span> state config a <span class="fu">=</span> <span class="dt">StateT</span> state (<span class="dt">ReaderT</span> config <span class="dt">IO</span>) a

<span class="co">-- Run a `Program` with a given state and config, returning</span>
<span class="co">-- a final value and the final state of the `Program`</span>
<span class="ot">runProgram ::</span> <span class="dt">Program</span> s c a <span class="ot">-&gt;</span> s <span class="ot">-&gt;</span> c <span class="ot">-&gt;</span> <span class="dt">IO</span> (a, s)
runProgram p s c <span class="fu">=</span> runReaderT (runStateT p s) c

<span class="kw">data</span> <span class="dt">CounterState</span> <span class="fu">=</span> <span class="dt">CounterState</span> {<span class="ot"> currentCount ::</span> <span class="dt">Integer</span> }

<span class="kw">data</span> <span class="dt">CounterConfig</span> <span class="fu">=</span> <span class="dt">CounterConfig</span>
    {<span class="ot"> countBy ::</span> <span class="dt">Integer</span>
    ,<span class="ot"> countUpTo ::</span> <span class="dt">Integer</span>
    }

<span class="co">-- A more specific type for our Counter program</span>
<span class="kw">type</span> <span class="dt">Counter</span> a <span class="fu">=</span> <span class="dt">Program</span> <span class="dt">CounterState</span> <span class="dt">CounterConfig</span> a

<span class="co">-- The initial state we're starting with</span>
<span class="ot">initialState ::</span> <span class="dt">CounterState</span>
initialState <span class="fu">=</span> <span class="dt">CounterState</span> <span class="dv">0</span>

<span class="co">-- Some code to read from our environment variables.</span>
<span class="co">-- Note: This is unsafe, and if either environment variable is</span>
<span class="co">-- a) not set, or</span>
<span class="co">-- b) not formatted like an integer,</span>
<span class="co">-- the program will currently error out.</span>
<span class="ot">getConfig ::</span> <span class="dt">IO</span> <span class="dt">CounterConfig</span>
getConfig <span class="fu">=</span> <span class="kw">do</span>
    countBy' <span class="ot">&lt;-</span> read <span class="fu">&lt;$&gt;</span> getEnv <span class="st">&quot;COUNT_BY&quot;</span>  
    countUpTo' <span class="ot">&lt;-</span> read <span class="fu">&lt;$&gt;</span> getEnv <span class="st">&quot;COUNT_UP_TO&quot;</span>
    pure <span class="fu">$</span> <span class="dt">CounterConfig</span> countBy' countUpTo' 

<span class="co">-- Our actual program (&quot;business logic&quot;)</span>
<span class="ot">counter ::</span> <span class="dt">Counter</span> () 
counter <span class="fu">=</span> <span class="kw">do</span>
    count <span class="ot">&lt;-</span> gets currentCount
    countUpTo' <span class="ot">&lt;-</span> lift <span class="fu">$</span> asks countUpTo

    unless (count <span class="fu">&gt;</span> countUpTo') <span class="fu">$</span> <span class="kw">do</span>
        liftIO <span class="fu">.</span> putStrLn <span class="fu">$</span> <span class="st">&quot;Current count: &quot;</span> <span class="fu">&lt;&gt;</span> show count 
        countBy' <span class="ot">&lt;-</span> lift <span class="fu">$</span> asks countBy
        <span class="kw">let</span> newCount <span class="fu">=</span> count <span class="fu">+</span> countBy'
        modify (\st <span class="ot">-&gt;</span> st{ currentCount <span class="fu">=</span> newCount })
        counter

<span class="ot">main ::</span> <span class="dt">IO</span> ()
main <span class="fu">=</span> <span class="kw">do</span>
    config <span class="ot">&lt;-</span> getConfig
    void <span class="fu">$</span> runProgram counter initialState config</code></pre></div>
<p>To run this, assuming it’s compiled to a program called <code>counter</code>:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="ot">COUNT_BY=</span>13 <span class="ot">COUNT_UP_TO=</span>100 <span class="kw">counter</span>
<span class="kw">Current</span> count: 0
<span class="kw">Current</span> count: 13
<span class="kw">Current</span> count: 26
<span class="kw">Current</span> count: 39
<span class="kw">Current</span> count: 52
<span class="kw">Current</span> count: 65
<span class="kw">Current</span> count: 78
<span class="kw">Current</span> count: 91</code></pre></div>
<p>Not so bad! This is totally enough to get started with some more complex programs. Anything below this point is just polish. I will go into all of these polishing modifications in more detail in later posts.</p>
<p>Anyway, the following things are a little ugly right now, in my opinion:</p>
<ul>
<li>Multiple calls to <code>lift</code> in <code>counter</code></li>
<li>The <code>modify</code> call in <code>counter</code> is not a cute line of code</li>
<li>We’re confined to <code>IO</code> as a base monad</li>
<li>As mentioned in comments, the configuration code will error out. Better to handle specific cases.</li>
</ul>
<p>The first thing I want to do is abolish the <code>lift</code> calls in <code>counter</code>.</p>
<p>We’ll need to add the <code>ConstraintKinds</code> and <code>FlexibleContexts</code> extensions to get this to compile, but here’s an updated program:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- Add this to the top of the file:</span>
<span class="ot">{-# LANGUAGE ConstraintKinds#-}</span>
<span class="ot">{-# LANGUAGE FlexibleContexts#-}</span>
<span class="fu">--</span>

<span class="co">-- An interface that describes the effects our program can have.</span>
<span class="kw">type</span> <span class="dt">MonadCounter</span> m <span class="fu">=</span> 
    ( <span class="dt">MonadState</span> <span class="dt">CounterState</span> m
    , <span class="dt">MonadReader</span> <span class="dt">CounterConfig</span> m
    , <span class="dt">MonadIO</span> m
    )

<span class="ot">counter ::</span> <span class="dt">MonadCounter</span> m <span class="ot">=&gt;</span> m () 
counter <span class="fu">=</span> <span class="kw">do</span>
    count <span class="ot">&lt;-</span> gets currentCount
    countUpTo' <span class="ot">&lt;-</span> asks countUpTo

    unless (count <span class="fu">&gt;</span> countUpTo') <span class="fu">$</span> <span class="kw">do</span>
        liftIO <span class="fu">.</span> putStrLn <span class="fu">$</span> <span class="st">&quot;Current count: &quot;</span> <span class="fu">&lt;&gt;</span> show count 
        countBy' <span class="ot">&lt;-</span> asks countBy
        <span class="kw">let</span> newCount <span class="fu">=</span> count <span class="fu">+</span> countBy'
        modify (\st <span class="ot">-&gt;</span> st{ currentCount <span class="fu">=</span> newCount })
        counter</code></pre></div>
<p>Everything else can stay the same. We’ve begun programming against the <code>MonadCounter</code> interface, which <code>Counter</code> just happens to satisfy, so we can still use our <code>runProgram</code> function. The interface contains the <code>State</code>/<code>Reader</code> functions, but removes the need for <code>lift</code>, which is nice.</p>
<blockquote>
<p>Note: If we remove the <code>MonadIO</code> constraint in <code>MonadCounter</code>, we’re no longer bound to using <code>IO</code> as our program’s base monad. It’s necessary for our current program (since <code>liftIO</code> is called), but for others it may not be.</p>
</blockquote>
<p>Next, let’s handle the ugly call to <code>modify</code>. We can clean this up with lenses. I’ll cover these in greater detail in a later post. For now, we’ll need a separate module, <code>Types</code>, containing the following (we also need the <a href="https://hackage.haskell.org/package/lens"><code>lens</code></a> library):</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">{-# LANGUAGE TemplateHaskell #-}</span>

<span class="kw">module</span> <span class="dt">Types</span> <span class="kw">where</span>

<span class="kw">import </span><span class="dt">Control.Lens</span>

<span class="kw">data</span> <span class="dt">CounterState</span> <span class="fu">=</span> <span class="dt">CounterState</span>
    { _<span class="ot">currentCount ::</span> <span class="dt">Integer</span>
    }

<span class="kw">data</span> <span class="dt">CounterConfig</span> <span class="fu">=</span> <span class="dt">CounterConfig</span>
    { _<span class="ot">countBy ::</span> <span class="dt">Integer</span>
    , _<span class="ot">countUpTo ::</span> <span class="dt">Integer</span>
    }

<span class="fu">$</span>(makeLenses <span class="ch">''</span><span class="dt">CounterState</span>)
<span class="fu">$</span>(makeLenses <span class="ch">''</span><span class="dt">CounterConfig</span>)</code></pre></div>
<p>This will give us lenses for <code>currentCount</code>, <code>countBy</code>, and <code>countUpTo</code>. We can then write <code>counter</code> as:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">counter ::</span> <span class="dt">MonadCounter</span> m <span class="ot">=&gt;</span> m () 
counter <span class="fu">=</span> <span class="kw">do</span>
    count <span class="ot">&lt;-</span> use currentCount
    countUpTo' <span class="ot">&lt;-</span> view countUpTo

    unless (count <span class="fu">&gt;</span> countUpTo') <span class="fu">$</span> <span class="kw">do</span>
        liftIO <span class="fu">.</span> putStrLn <span class="fu">$</span> <span class="st">&quot;Current count: &quot;</span> <span class="fu">&lt;&gt;</span> show count 
        countBy' <span class="ot">&lt;-</span> view countBy
        currentCount <span class="fu">+=</span> countBy'
        counter</code></pre></div>
<p>I think that’s quite nice and readable.</p>
<p>I’m going to postpone talking about reading environment variables because I want to dedicate a whole <em>Haskell Bit</em> to reading configuration safely, and this one is getting somewhat long.</p>
<p>Is there a topic you would like to see covered in the future? Do you start your projects in a wildly different way? Let me know in the comments!</p>
<p>Ben</p>
</div>

<div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'abstract-nonsense'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

</p>
      </section>
      <footer class="footer">
        © 2018 Benjamin Kovach
        <br />
        Site proudly generated by <a href="https://jaspervdj.be/hakyll/">Hakyll</a>
      </footer>
    </div>
    <!-- Google Analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-53651640-1', 'auto');
      ga('send', 'pageview');

    </script>
    <script>
      lightbox.option({
        resizeDuration: 200,
      })
    </script>
  </body>
</html>
