<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Abstract Nonsense</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link rel="stylesheet" type="text/css" href="../css/default.css" />
    <link rel="stylesheet" type="text/css" href="../css/syntax.css" />
    <link rel="stylesheet" type="text/css" href="../css/site.css" />
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.4.3/jquery.min.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css" />
    <link rel="stylesheet" href="../js/lightbox2/dist/css/lightbox.min.css" />
    <script type="text/javascript" src="../js/lightbox2/dist/js/lightbox-plus-jquery.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
  </head>
  <body style="margin-left: auto; margin-right: auto; display: block; max-width:800px">
    <div id="left"></div>
    <div class="wrapper">
      <header>
        <ul id="nav">
    <li><a href="../">Home</a></li>
    <li><a href="../contact.html">About</a></li>
    <li><a href="../atom.xml">Atom</a></li>
    <li><a href="../rss.xml">RSS</a></li>
</ul>


        <h3 id="blog_title">Abstract Nonsense: Ramblings by Benjamin Kovach</h3>
      </header>
      <section>
        
          <h4 class="post-title">Haskell Bits #5 - Easily working with JSON</h4>
        
        <p>
<div class="post_body">
	<p>JSON is ubiquitous nowadays, perhaps most importantly for web APIs. We’ll probably need to interact with (or build) one of those at some point, so we must be able to handle JSON in Haskell, right?</p>
<p>Yep - also it’s pretty easy. Let’s talk about it! First, some boilerplate to get out of the way:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span>
<span class="ot">{-# LANGUAGE DeriveGeneric #-}</span>
<span class="ot">{-# LANGUAGE TemplateHaskell #-}</span>
<span class="ot">{-# LANGUAGE MultiParamTypeClasses #-}</span>
<span class="ot">{-# LANGUAGE FunctionalDependencies #-}</span>

<span class="kw">import </span><span class="dt">Control.Lens</span> ((^.), (^?))
<span class="kw">import </span><span class="dt">Control.Lens.TH</span>
<span class="kw">import </span><span class="dt">Data.Aeson.Lens</span>
<span class="kw">import </span><span class="dt">Data.Aeson</span>
<span class="kw">import </span><span class="dt">Data.Aeson.Types</span>
<span class="kw">import </span><span class="dt">Data.Aeson.TH</span>
<span class="kw">import qualified</span> <span class="dt">Data.ByteString.Lazy.Char8</span> <span class="kw">as</span> <span class="dt">BL</span>
<span class="kw">import qualified</span> <span class="dt">Data.Text</span> <span class="kw">as</span> <span class="dt">T</span>
<span class="kw">import </span><span class="dt">GHC.Generics</span></code></pre></div>
<p>Try not to get too overwhelmed with that giant chunk of imports and extensions. Most of it is only for the template haskell we’ll be using later. The important bit for now is <code>Data.Aeson</code> from the <code>aeson</code> package, which allows us to seamlessly work with JSON. We’ll need <code>lens</code> and <code>lens-aeson</code> packages later on.</p>
<p>Let’s pretend we have some API we’re building and want to generate a static blob of JSON for the front page. How about this:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">index<span class="ot"> ::</span> <span class="dt">Value</span>
index <span class="fu">=</span> object
    [ <span class="st">&quot;message&quot;</span> <span class="fu">.=</span> <span class="dt">String</span> <span class="st">&quot;Congrats!&quot;</span>
    , <span class="st">&quot;status&quot;</span> <span class="fu">.=</span> <span class="dt">String</span> <span class="st">&quot;YOU_GOT_HERE_SO_OBVIOUSLY_SUCCESSFUL&quot;</span>
    , <span class="st">&quot;metadata&quot;</span> <span class="fu">.=</span> object [
        <span class="st">&quot;version&quot;</span> <span class="fu">.=</span> <span class="dt">Number</span> <span class="dv">9</span>
      ]
    ]</code></pre></div>
<p><code>Value</code> is the type of JSON values in Haskell. We can build up an object using the <code>object</code> functions, and a mapping from keys to <code>Value</code>s, generated by <code>String</code>, <code>Number</code>, and other functions.</p>
<p>We can encode a <code>Value</code> with <code>encode</code>. It produces a lazy <code>ByteString</code>:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">BL.putStrLn <span class="fu">$</span> encode index
<span class="co">-- { &quot;status&quot;:&quot;YOU_GOT_HERE_SO_OBVIOUSLY_SUCCESSFUL&quot;,&quot;metadata&quot;:{&quot;version&quot;:9},&quot;message&quot;:&quot;Congrats!&quot;}</span></code></pre></div>
<p>Next up, I’d like to show how a client might interact with this thing. If they have the unpacked <code>Value</code>, they can access the value at the <code>message</code> key like this:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">index <span class="fu">^.</span> key <span class="st">&quot;message&quot;</span> <span class="fu">.</span> _<span class="dt">String</span>
<span class="co">-- &quot;Congrats!&quot;</span></code></pre></div>
<p>What’s even better is that we don’t even need to unpack the <code>Value</code>! We can operate directly on the encoded JSON:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">encode index <span class="fu">^.</span> key <span class="st">&quot;message&quot;</span> <span class="fu">.</span> _<span class="dt">String</span>
<span class="co">-- &quot;Congrats!&quot;</span></code></pre></div>
<p>We can dig into the nested fields safely using <code>^?</code>:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">index <span class="fu">^?</span> key <span class="st">&quot;metadata&quot;</span> <span class="fu">.</span> key <span class="st">&quot;app_version&quot;</span> <span class="fu">.</span> _<span class="dt">Number</span>
<span class="co">-- Just 9.0</span></code></pre></div>
<p>All <code>Lens</code> idioms apply. It’s easy to get, set, or modify arbitrary fields of JSON objects this way.</p>
<p>Let’s say we want to start building up our application and require more type safety. <code>aeson</code> makes it easy to generate encoding and decoding mechanisms for your data types. For instance, we can define the following two types, generate lenses (via <code>makeFields</code>) and <code>ToJSON</code> and <code>FromJSON</code> instances using a bit of template haskell:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">data</span> <span class="dt">Metadata</span> <span class="fu">=</span> <span class="dt">Metadata</span>
    { _<span class="ot">metadataAppVersion ::</span> <span class="dt">Int</span>
    } <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>, <span class="dt">Generic</span>)

<span class="fu">$</span>(deriveJSON
    defaultOptions
        { fieldLabelModifier <span class="fu">=</span> camelTo2 <span class="ch">'_'</span> <span class="fu">.</span> drop (T.length <span class="st">&quot;_metadata&quot;</span>)
        } <span class="ch">''</span><span class="dt">Metadata</span>)
<span class="fu">$</span>(makeFields <span class="ch">''</span><span class="dt">Metadata</span>)

<span class="kw">data</span> <span class="dt">IndexResponse</span> <span class="fu">=</span> <span class="dt">IndexResponse</span>
    { _<span class="ot">indexResponseMessage ::</span> <span class="dt">T.Text</span>
    , _<span class="ot">indexResponseStatus ::</span> <span class="dt">T.Text</span>
    , _<span class="ot">indexResponseMetadata ::</span> <span class="dt">Metadata</span>
    } <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>, <span class="dt">Generic</span>)

<span class="fu">$</span>(deriveJSON
    defaultOptions
        { fieldLabelModifier <span class="fu">=</span> camelTo2 <span class="ch">'_'</span> <span class="fu">.</span> drop (T.length <span class="st">&quot;_indexResponse&quot;</span>)
        } <span class="ch">''</span><span class="dt">IndexResponse</span>)
<span class="fu">$</span>(makeFields <span class="ch">''</span><span class="dt">IndexResponse</span>)</code></pre></div>
<p>Here’s the same <code>index</code> structure, now typed more explicitly:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">indexResponse ::</span> <span class="dt">IndexResponse</span>
indexResponse <span class="fu">=</span> <span class="dt">IndexResponse</span>
    <span class="st">&quot;Congrats!&quot;</span>
    <span class="st">&quot;YOU_GOT_HERE_SO_OBVIOUSLY_SUCCESSFUL&quot;</span>
    (<span class="dt">Metadata</span> <span class="dv">9</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">BL.putStrLn <span class="fu">$</span> encode indexResponse
<span class="co">-- {&quot;message&quot;:&quot;Congrats!&quot;,&quot;status&quot;:&quot;YOU_GOT_HERE_SO_OBVIOUSLY_SUCCESSFUL&quot;,&quot;metadata&quot;:{&quot;app_version&quot;:9}}</span></code></pre></div>
<p>Note that the <code>appVersion</code> field gets automatically converted from <code>camelCase</code> to <code>snake_case</code> with the <code>camelTo2</code> option from <code>Data.Aeson.Types</code>. Handy!</p>
<p>We can check that encoding and decoding works, and use more type-safe lenses (in this case, <code>message</code>, which was generated by <code>makeFields</code>):</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">(decode (encode indexResponse)<span class="ot"> ::</span> <span class="dt">Maybe</span> <span class="dt">IndexResponse</span>) <span class="fu">^.</span> _<span class="dt">Just</span> <span class="fu">.</span> message
<span class="co">-- &quot;Congrats!&quot;</span></code></pre></div>
<p>As you can see, dealing with JSON in Haskell is a breeze! What other tips and tricks do you use when dealing with JSON (de)serialization (in Haskell or otherwise)?</p>
<p>Until next time,</p>
<p>Ben</p>
<p>You can read more about <code>aeson</code> and <code>lens-aeson</code> in the docs:</p>
<ul>
<li><a href="https://www.stackage.org/lts-8.13/package/aeson-1.0.2.1">aeson</a></li>
<li><a href="https://www.stackage.org/lts-8.13/package/lens-aeson-1.0.1">lens-aeson</a></li>
</ul>
</div>
</p>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'abstract-nonsense'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

      </section>
      <footer class="footer">
        © 2016 Benjamin Kovach
        <br />
        Site proudly generated by <a href="https://jaspervdj.be/hakyll/">Hakyll</a>
      </footer>
    </div>
    <!-- Google Analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-53651640-1', 'auto');
      ga('send', 'pageview');

    </script>
    <script>
      lightbox.option({
        resizeDuration: 200,
      })
    </script>
  </body>
</html>
