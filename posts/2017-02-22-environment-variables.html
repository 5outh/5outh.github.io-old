<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Abstract Nonsense</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link rel="stylesheet" type="text/css" href="../css/default.css" />
    <link rel="stylesheet" type="text/css" href="../css/syntax.css" />
    <link rel="stylesheet" type="text/css" href="../css/site.css" />
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.4.3/jquery.min.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css" />
    <link rel="stylesheet" href="../js/lightbox2/dist/css/lightbox.min.css" />
    <script type="text/javascript" src="../js/lightbox2/dist/js/lightbox-plus-jquery.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
  </head>
  <body style="margin-left: auto; margin-right: auto; display: block; max-width:800px">
    <div id="left"></div>
    <div class="wrapper">
      <header>
        <ul id="nav">
    <li><a href="../">Home</a></li>
    <li><a href="../contact.html">About</a></li>
    <li><a href="../atom.xml">Atom</a></li>
    <li><a href="../rss.xml">RSS</a></li>
</ul>


        <h3 id="blog_title">Abstract Nonsense: Ramblings by Benjamin Kovach</h3>
      </header>
      <section>
        
          <h4 class="post-title">Haskell Bits #4 - Environment Variables</h4>
        
        <p>
<div class="post_body">
	<p>It’s likely that you’ll have to deal with environment variables at some point. What I’ll describe here is a kicking-off point for robust environment handling with little overhead. We’ll build a tiny library you can drop into any application that will make dealing with environment variables for configuration a lot easier. Then I’ll show some example usage.</p>
<p>This is all built on top of <code>System.Environment</code>, which isn’t super nice to use in its raw form. In particular, there no implicit facilities for type coercion, fallback values, or composability. We’ll address those problems here.</p>
<p>You’ll need the following libraries to get run the code in this post: <code>transformers</code>, <code>split</code> and <code>safe</code>.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span>

<span class="kw">import </span><span class="dt">System.Environment</span> <span class="kw">hiding</span> (getEnv)
<span class="kw">import </span><span class="dt">Control.Monad.Trans.Maybe</span>
<span class="kw">import </span><span class="dt">Control.Monad.IO.Class</span>
<span class="kw">import </span><span class="dt">Control.Applicative</span>
<span class="kw">import </span><span class="dt">Control.Monad</span>
<span class="kw">import </span><span class="dt">Safe</span>
<span class="kw">import </span><span class="dt">Data.List.Split</span>

<span class="kw">newtype</span> <span class="dt">Env</span> a <span class="fu">=</span> <span class="dt">Env</span>{<span class="ot"> unEnv ::</span> <span class="dt">MaybeT</span> <span class="dt">IO</span> a }
    <span class="kw">deriving</span>
        ( <span class="dt">Functor</span>
        , <span class="dt">Applicative</span>
        , <span class="dt">Monad</span>
        , <span class="dt">MonadIO</span>
        , <span class="dt">Alternative</span>
        , <span class="dt">MonadPlus</span>
        )

<span class="ot">runEnv ::</span> <span class="dt">Env</span> a <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> a)
runEnv <span class="fu">=</span> runMaybeT <span class="fu">.</span> unEnv

<span class="co">-- Lift a `Maybe` into the `Env` context.</span>
<span class="ot">liftMaybe ::</span> <span class="dt">Maybe</span> a <span class="ot">-&gt;</span> <span class="dt">Env</span> a
liftMaybe <span class="fu">=</span> <span class="dt">Env</span> <span class="fu">.</span> <span class="dt">MaybeT</span> <span class="fu">.</span> pure

<span class="co">-- Get an environment variable in its</span>
<span class="co">-- raw form.</span>
<span class="ot">getEnv ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Env</span> <span class="dt">String</span>
getEnv key <span class="fu">=</span>
    liftIO (lookupEnv key) <span class="fu">&gt;&gt;=</span> liftMaybe

<span class="co">-- Pull an environment variable from</span>
<span class="co">-- the environment, using a parsing</span>
<span class="co">-- function for conversion.</span>
<span class="ot">env ::</span> (<span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> a) <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Env</span> a
env f key <span class="fu">=</span> liftMaybe <span class="fu">.</span> f <span class="fu">=&lt;&lt;</span> getEnv key

<span class="co">-- Pull an optional value from the</span>
<span class="co">-- environment.</span>
optional
<span class="ot">    ::</span> (<span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> a)
    <span class="ot">-&gt;</span> <span class="dt">String</span>
    <span class="ot">-&gt;</span> <span class="dt">Env</span> (<span class="dt">Maybe</span> a)
optional f key <span class="fu">=</span>
    (f <span class="fu">&lt;$&gt;</span> getEnv key) <span class="fu">&lt;|&gt;</span> pure <span class="dt">Nothing</span> 

<span class="co">-- Exploit the `Read` interface for a type</span>
<span class="co">-- to read an environment variable.</span>
<span class="ot">readEnv ::</span> <span class="dt">Read</span> a <span class="ot">=&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Env</span> a
readEnv <span class="fu">=</span> env readMay</code></pre></div>
<p>This code was adapted from <a href="https://www.reddit.com/r/haskell/comments/3bckm7/envy_an_environmentally_friendly_way_to_deal_with/csl3nqa/">a comment on reddit</a> (credit to u/Tekmo).</p>
<p>I think this mini-library is “good enough” for a lot of applications. One major drawback is that it doesn’t report missing or improperly formatted environment variables - functionality can be added in a relatively straightforward way, however, with a <code>MonadThrow</code> constraint. This is the simplest thing that does the job well, though, so we’ll run with it.</p>
<p>For my example application, I want to be able to pull configuration information from a set of environment variables.</p>
<p>We can use our mini-library to do this:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">data</span> <span class="dt">Stage</span> 
  <span class="fu">=</span> <span class="dt">Testing</span>
  <span class="fu">|</span> <span class="dt">Development</span>
  <span class="fu">|</span> <span class="dt">Staging</span> 
  <span class="fu">|</span> <span class="dt">Production</span>
    <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Read</span>)

<span class="kw">data</span> <span class="dt">Version</span> <span class="fu">=</span> <span class="dt">Version</span> <span class="dt">Int</span> <span class="dt">Int</span> <span class="dt">Int</span>
    <span class="kw">deriving</span> <span class="dt">Show</span>

<span class="kw">data</span> <span class="dt">MyEnvironment</span> <span class="fu">=</span> <span class="dt">MyEnvironment</span>
    {<span class="ot"> stage ::</span> <span class="dt">Stage</span>
    ,<span class="ot"> identifier ::</span> <span class="dt">Maybe</span> <span class="dt">String</span>
    ,<span class="ot"> version ::</span> <span class="dt">Version</span>
    } <span class="kw">deriving</span> (<span class="dt">Show</span>)

<span class="co">-- Parse a semantic version string like v1.3.3</span>
<span class="ot">parseVersion ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Version</span>
parseVersion versionString <span class="fu">=</span>
    <span class="kw">case</span> splitOn <span class="st">&quot;.&quot;</span> semver <span class="kw">of</span>
         [major, minor, patch] <span class="ot">-&gt;</span>
             <span class="dt">Version</span>
                <span class="fu">&lt;$&gt;</span> readMay major
                <span class="fu">&lt;*&gt;</span> readMay minor
                <span class="fu">&lt;*&gt;</span> readMay patch
         _ <span class="ot">-&gt;</span> <span class="dt">Nothing</span>
    <span class="kw">where</span> semver <span class="fu">=</span> tail versionString

<span class="co">-- An environment reader for `MyEnvironment`</span>
<span class="ot">myEnv ::</span> <span class="dt">Env</span> <span class="dt">MyEnvironment</span>
myEnv <span class="fu">=</span> <span class="dt">MyEnvironment</span>
    <span class="fu">&lt;$&gt;</span> (readEnv <span class="st">&quot;APP_STAGE&quot;</span> <span class="fu">&lt;|&gt;</span> pure <span class="dt">Production</span>)
    <span class="fu">&lt;*&gt;</span> optional <span class="dt">Just</span> <span class="st">&quot;APP_ID&quot;</span>
    <span class="fu">&lt;*&gt;</span> env parseVersion <span class="st">&quot;APP_VERSION&quot;</span>

<span class="ot">main ::</span> <span class="dt">IO</span> ()
main <span class="fu">=</span> runEnv myEnv <span class="fu">&gt;&gt;=</span> print</code></pre></div>
<p>Running this as an executable <code>my_app</code>, we get the following output (formatting mine):</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">$</span> <span class="dt">APP_STAGE</span><span class="fu">=</span><span class="dt">Testing</span> <span class="dt">APP_VERSION</span><span class="fu">=</span>v1<span class="fu">.</span><span class="fl">1.1</span> <span class="dt">APP_ID</span><span class="fu">=</span>its_me_mario my_app

<span class="dt">Just</span> (
  <span class="dt">MyEnvironment</span>
    { stage <span class="fu">=</span> <span class="dt">Testing</span>
    , identifier <span class="fu">=</span> <span class="dt">Just</span> <span class="st">&quot;its_me_mario&quot;</span>
    , version <span class="fu">=</span> <span class="dt">Version</span> <span class="dv">1</span> <span class="dv">1</span> <span class="dv">1</span>
    }
  )</code></pre></div>
<p>Or, with some missing/incomplete information:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">$</span> <span class="dt">APP_STAGE</span><span class="fu">=</span>nonexistent <span class="dt">APP_VERSION</span><span class="fu">=</span>v1<span class="fu">.</span><span class="fl">1.4</span> my_app

<span class="dt">Just</span> (
  <span class="dt">MyEnvironment</span>
    { stage <span class="fu">=</span> <span class="dt">Production</span>
    , identifier <span class="fu">=</span> <span class="dt">Nothing</span>
    , version <span class="fu">=</span> <span class="dt">Version</span> <span class="dv">1</span> <span class="dv">1</span> <span class="dv">4</span>
    }
  )</code></pre></div>
<p>What do you use for handling environment variables in Haskell? Do you use environment variables for different purposes that you’d like to see covered? What else would you like to see covered in future Haskell Bits? Let me know in the comments!</p>
<p>Ben</p>
</div>
</p>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'abstract-nonsense'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

      </section>
      <footer class="footer">
        © 2016 Benjamin Kovach
        <br />
        Site proudly generated by <a href="https://jaspervdj.be/hakyll/">Hakyll</a>
      </footer>
    </div>
    <!-- Google Analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-53651640-1', 'auto');
      ga('send', 'pageview');

    </script>
    <script>
      lightbox.option({
        resizeDuration: 200,
      })
    </script>
  </body>
</html>
